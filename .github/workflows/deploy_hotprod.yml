name: 🚀 Déploiement optimisé site HotProd (FR/EN)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 🧩 Cloner le dépôt
        uses: actions/checkout@v4

      - name: ⚙️ Configurer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: 📦 Installer dépendances nécessaires
        run: |
          python -m pip install --upgrade pip
          pip install beautifulsoup4 htmlmin css-html-js-minify

      - name: 🏗️ Construire le site statique
        run: |
          echo "⚙️ Construction du site HotProd..."
          python agents/agent_build_html.py
          python agents/agent_index_root.py
          python agents/agent_qa.py

      - name: ✨ Minification des fichiers HTML/CSS/JS
        run: |
          echo "🔧 Minification du code..."
          python - <<'PY'
          import os, htmlmin
          from css_html_js_minify import process_single_html_file
          
          dossiers = ["fr", "en", "."]
          fichiers = []
          for dossier in dossiers:
              if not os.path.exists(dossier): continue
              for root, _, files in os.walk(dossier):
                  for f in files:
                      if f.endswith(".html") or f.endswith(".css") or f.endswith(".js"):
                          fichiers.append(os.path.join(root, f))

          print(f"Minification de {len(fichiers)} fichiers...")
          for f in fichiers:
              try:
                  process_single_html_file(f)
                  with open(f, "r+", encoding="utf-8") as file:
                      contenu = file.read()
                      minifie = htmlmin.minify(contenu, remove_empty_space=True)
                      file.seek(0)
                      file.write(minifie)
                      file.truncate()
                  print(f"✅ {f} minifié")
              except Exception as e:
                  print(f"⚠️ Erreur minification {f}: {e}")
          PY

      - name: 🌐 Déploiement GitHub Pages
        run: |
          echo "📤 Déploiement sur GitHub Pages..."
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add fr en index.html
          git commit -m "🚀 Publication optimisée du site HotProd" || echo "Aucune modification détectée."
          git push || echo "Push non nécessaire."
