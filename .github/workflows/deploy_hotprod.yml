name: Deploy HotProd site (FR/EN)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install minify tools
        run: |
          python -m pip install --upgrade pip
          pip install htmlmin css-html-js-minify

      - name: Minify HTML/CSS
            - name: üîç Optimisation SEO automatique
        run: |
          pip install beautifulsoup4
          python agents/agent_seo_optimize.py
        run: |
          python - <<'PY'
import os, htmlmin
from css_html_js_minify import process_single_html_file
files=[]
for root,_,fs in os.walk("."):
  for f in fs:
    if f.endswith(".html") or f.endswith(".css") or f.endswith(".js"):
      if root.startswith(".github"): continue
      files.append(os.path.join(root,f))
print("Files to minify:", len(files))
for path in files:
  try:
    if path.endswith(".html"):
      with open(path, "r", encoding="utf-8") as fh:
        content=fh.read()
      minified=htmlmin.minify(content, remove_empty_space=True)
      with open(path,"w",encoding="utf-8") as fh:
        fh.write(minified)
    else:
      process_single_html_file(path)
  except Exception as e:
    print("skip",path,e)
PY

      - name: Commit minified files
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "ci: minify site" || echo "no changes"
          git push || echo "push failed"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
