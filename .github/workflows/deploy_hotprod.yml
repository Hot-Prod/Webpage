name: Deploy HotProd site (FR/EN + SEO + Minify)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install htmlmin css-html-js-minify beautifulsoup4

      - name: Run SEO optimization
        run: |
          python agents/agent_seo_optimize.py

      - name: Minify HTML and CSS
        run: |
          python - <<EOF
import os, htmlmin
from css_html_js_minify import process_single_html_file

for root, _, files in os.walk("."):
    for f in files:
        if f.endswith(".html") or f.endswith(".css"):
            if root.startswith("./.github"):
                continue
            path = os.path.join(root, f)
            try:
                if f.endswith(".html"):
                    with open(path, "r", encoding="utf-8") as file:
                        content = file.read()
                    minified = htmlmin.minify(content, remove_empty_space=True)
                    with open(path, "w", encoding="utf-8") as file:
                        file.write(minified)
                else:
                    process_single_html_file(path)
                print(f"✅ Minifié : {path}")
            except Exception as e:
                print(f"⚠️ Erreur sur {path}: {e}")
EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
